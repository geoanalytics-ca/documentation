<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.04.07"/>
        <title>Docker &amp; Pipelines - GeoAnalytics Canada Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=68f4518137b9aefe99b631505a2064c3c42c9852" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">GeoAnalytics Canada Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/geoanalytics-icon.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">GeoAnalytics Canada Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="index.html">Getting Started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="00-how-to-use-this-documentation.html">How to use this documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="02-geospatial-python.html"><strong>Working with Earth Observation data in Python</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="04-authentication.html"><strong>Authentication</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="03-jupyter-notebooks.html"><strong>Jupyter Notebooks</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="05-desktop-vm.html"><strong>Desktop VM’s</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="05a-ssh-keys.html">Set Up SSH Keys to access Remote Desktop VM over SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="05b-remote-connect-vscode.html">Remote Connection via VSCode</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-file-browser.html"><strong>File Browser</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="07-stac.html"><strong>SpatioTemporal Asset Catalog (STAC)</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="08-container-registry.html"><strong>Container Registry</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="09-pipelines.html">Pipelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="10-dask.html"><strong>Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="12-APIs.html">APIs</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2_real_world_examples/index.html">Real World Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/01-accessing-data.html"><strong>Accessing and Downloading Data</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/02-ndvi-s2-dask.html"><strong>NDVI with Sentinel-2 and Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/03-ndsi-modis-dask.html"><strong>NDSI with MODIS and Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/04-ndmi-landsat8-dask.html"><strong>NDMI with Landsat 8 Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/05-change-detection.html"><strong>Change Detection</strong></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../3_scientific_workflows/index.html">Scientific Workflows</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../3_scientific_workflows/01-daily-ndsi-pipeline.html"><strong>Daily NDSI Average Pipeline</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../3_scientific_workflows/02-kmeans-dask.html">K-Means Land Classification with Dask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3_scientific_workflows/03-composite.html">Compositing Rasters with Dask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3_scientific_workflows/04-add-to-stac.html"><strong>Adding data to the Geoanalytics STAC server</strong></a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="docker-pipelines">
<h1>Docker &amp; Pipelines<a class="headerlink" href="#docker-pipelines" title="Permalink to this headline">#</a></h1>
<p>Pairing Docker with Pipelines enables us to create customized solutions
that we have full control over.
Defining environments to run applications inside a <code class="docutils literal notranslate"><span class="pre">dockerfile</span></code> and
running them in an isolated space on the Pipelines engine allows
for a secure and reproducible environment to run tests and/or
(scheduled) reproducible workflows.</p>
<ul class="simple">
<li><p><span class="xref myst">Docker &amp; Pipelines</span></p>
<ul>
<li><p><span class="xref myst">Useful Links</span></p></li>
<li><p><span class="xref myst">Environtment Variables</span></p></li>
<li><p><span class="xref myst">Docker in the Remote Desktop</span></p></li>
<li><p><span class="xref myst">Using Docker and Pipelines</span></p></li>
<li><p><span class="xref myst">Example Project</span></p></li>
<li><p><span class="xref myst">Dockerfile</span></p></li>
<li><p><span class="xref myst">Building and Pushing to the Container Registry</span></p></li>
<li><p><span class="xref myst">Using Your Docker Image in a Pipeline</span></p>
<ul>
<li><p><span class="xref myst">Hera-Workflows</span></p></li>
<li><p><span class="xref myst">Couler</span></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<section id="useful-links">
<h2>Useful Links<a class="headerlink" href="#useful-links" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.docker.com/engine/api/">Docker Container Engine API</a></p></li>
<li><p><a class="reference external" href="https://docs.docker.com/engine/reference/builder/">Dockerfile Reference</a></p></li>
<li><p><a class="reference external" href="https://hera-workflows.readthedocs.io/en/latest/?badge=latest">Hera-Workflows API &amp; Examples</a></p></li>
<li><p><a class="reference external" href="https://couler-proj.github.io/couler/">Couler Documentation</a></p></li>
</ul>
</section>
<section id="environtment-variables">
<h2>Environtment Variables<a class="headerlink" href="#environtment-variables" title="Permalink to this headline">#</a></h2>
<p>The following Pipeline workflow accesses various environment variables to
set appropriate values in the configuration functions.</p>
<blockquote>
<div><p><strong>Note</strong><br/>
You can find a table of all relevant environment variables for
the Pipeline under <code class="docutils literal notranslate"><span class="pre">/home/jovyan/config/</span></code> in your JupyterHub filebrowser tab. Right click, Open With, and then select “Render Markdown” to see
a user-friendly table.</p>
</div></blockquote>
</section>
<section id="docker-in-the-remote-desktop">
<h2>Docker in the Remote Desktop<a class="headerlink" href="#docker-in-the-remote-desktop" title="Permalink to this headline">#</a></h2>
<p>Docker is running in a sidecar to the remote desktop.
What this means is that the daemon is not running inside
the remote desktop directly, but adjacent to it.
This does not affect the way you interact with Docker,
but is useful to know if you’re looking for the daemon.</p>
<p>To run Docker commands against the daemon, you can
accomplish this using <code class="docutils literal notranslate"><span class="pre">sudo</span></code>, as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>docker<span class="w"> </span><span class="nb">command</span><span class="w"> </span>...
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">command</span></code> is a Docker command such as <code class="docutils literal notranslate"><span class="pre">images</span></code>, <code class="docutils literal notranslate"><span class="pre">ps</span></code>, <code class="docutils literal notranslate"><span class="pre">build</span></code>, <code class="docutils literal notranslate"><span class="pre">push</span></code>, etc.</p>
<p><a class="reference external" href="https://docs.docker.com/engine/reference/commandline/docker/">Docker Commands</a></p>
</section>
<section id="using-docker-and-pipelines">
<h2>Using Docker and Pipelines<a class="headerlink" href="#using-docker-and-pipelines" title="Permalink to this headline">#</a></h2>
<p>The below Sections will go over how to leverage Docker for your
own Pipeline workflows.</p>
</section>
<section id="example-project">
<h2>Example Project<a class="headerlink" href="#example-project" title="Permalink to this headline">#</a></h2>
<p>The following code shows a simple project folder:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>project/
<span class="w">  </span>dockerfile
<span class="w">  </span>src/
<span class="w">      </span>-<span class="w"> </span>requirements.txt
<span class="w">      </span>-<span class="w"> </span>main.py<span class="w">        </span><span class="c1"># main python app</span>
<span class="w">      </span>-<span class="w"> </span>lib/
<span class="w">          </span>-<span class="w"> </span>helpers.py<span class="w"> </span><span class="c1"># subdirectory example</span>
<span class="w">      </span>-<span class="w"> </span>entrypoint.sh<span class="w">  </span><span class="c1"># runs application via script</span>
<span class="w">      </span>-<span class="w"> </span>README.md
<span class="w">  </span>README.md
</pre></div>
</div>
<p>The following is the contents of a <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># /src/requirements.txt
xarray==2022.10.0
numpy==1.23.3
pandas==1.5.1
geopandas==0.12.1
</pre></div>
</div>
<p>Where the <code class="docutils literal notranslate"><span class="pre">entrypoint.sh</span></code> script looks something like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">set</span><span class="w"> </span>-eu

python<span class="w"> </span>main.py
</pre></div>
</div>
</section>
<section id="dockerfile">
<h2>Dockerfile<a class="headerlink" href="#dockerfile" title="Permalink to this headline">#</a></h2>
<p>To build a Container Image, once the application has
been implemented, you will need to use a <code class="docutils literal notranslate"><span class="pre">dockerfile</span></code> manifest
to allow the Container Engine to containerize your application.</p>
<p>This <code class="docutils literal notranslate"><span class="pre">dockerfile</span></code> describes the environment which
your application will run in.
It it highly recommend to keep this as small (dependency disksize) as necessary to run your application.</p>
<blockquote>
<div><p><strong>Note</strong><br/>
Smaller Images help speed up pulling of the Image as well as minimizing the
amount of resources required to host the application. Giving those
resources back to the application to use.</p>
</div></blockquote>
<div class="highlight-dockerfile notranslate"><div class="highlight"><pre><span></span>FROM python:3.10.9-slim

RUN apt update &amp;&amp; apt install -y \
      software-properties-common

COPY src/ /app

RUN pip install -r /app/requirements.txt
RUN chmod 0555 entrypoint # Read and Execute

# ENTRYPOINT ['/bin/bash', '-c', 'entryscript.sh'] # Custom script entrypoint
ENTRYPOINT ['python', 'main.py'] # Run Python application

</pre></div>
</div>
</section>
<section id="building-and-pushing-to-the-container-registry">
<h2>Building and Pushing to the Container Registry<a class="headerlink" href="#building-and-pushing-to-the-container-registry" title="Permalink to this headline">#</a></h2>
<p>First, to ensure we can push our built Container Image, we must login to our container registry with your provided username and password:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>docker<span class="w"> </span>login<span class="w"> </span>registry.eo4ph.geoanalytics.ca
</pre></div>
</div>
<p>Using the below information, replace the keywords in
the subsequent Docker commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">project-name</span></code> : The name of your project in the Container Registry</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">image-name</span></code> : The name that describes the Container Image</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">image-tag</span></code> : The version of the Image being built</p></li>
</ul>
<p>Next, we must build and tag our Container Image
so that it will push to the correct registry:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>registry.eo4ph.geoanalytics.ca/project-name/image-name:image-tag<span class="w"> </span>.
</pre></div>
</div>
<p>Finally, we can push the successfully built Container Image:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>registry.eo4ph.geoanalytics.ca/project-name/image-name:image-tag
</pre></div>
</div>
<p>You can also run your container:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-it<span class="w"> </span>registry.eo4ph.geoanalytics.ca/project-name/image-name:image-tag
</pre></div>
</div>
</section>
<section id="using-your-docker-image-in-a-pipeline">
<h2>Using Your Docker Image in a Pipeline<a class="headerlink" href="#using-your-docker-image-in-a-pipeline" title="Permalink to this headline">#</a></h2>
<p>The following two Python frameworks,
<a class="reference external" href="https://hera-workflows.readthedocs.io/en/latest/index.html">Hera-Workflows</a>
and <a class="reference external" href="https://couler-proj.github.io/couler/">Couler</a>, can submit
Workflows to our pipeline executor and can be monitored here:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://pipeline.eo4ph.geoanalytics.ca">GEOAnalytics Pipelines</a></p></li>
</ul>
<section id="hera-workflows">
<h3>Hera-Workflows<a class="headerlink" href="#hera-workflows" title="Permalink to this headline">#</a></h3>
<p>Hera-Workflows is a pipeline framework built by argoproj - the creators of Argo Workflows.
When you need more control over your pipeline, consider using
Hera-Workflows SDK as it provides a more mature and stable framework.</p>
<p>Hera-Workflows is capable of setting the number of
parallel tasks permitted to run at any one time, this enables more
fine-tuned allocation of resources. This especially comes in handy,
for example, when downloading data from Earthdata and server rate limits
causes a Failure for the task to complete.</p>
<p>Caveats:</p>
<ul class="simple">
<li><p>Argo requires unique names for Workflows and will complain if duplicates are submitted</p></li>
</ul>
<p>Benefits:</p>
<ul class="simple">
<li><p>Use both images from the private registry and and those publically available, too (eg. from DockerHub)</p></li>
</ul>
<p>Thow following code will set up the framework for a simple pipeline:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure GEOAnalytics Pipeline Environment</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">hera</span><span class="o">.</span><span class="n">workflow_service</span><span class="o">.</span><span class="n">WorkflowService</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'PIPELINE_HOST'</span><span class="p">),</span>
    <span class="n">namespace</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'PIPELINE_NS'</span><span class="p">),</span>
    <span class="n">token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'PIPELINE_TOKEN'</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">node_selectors</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NODE_SELECTOR_KEY'</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NODE_SELECTOR_VALUE_SMALL'</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">tolerations</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">hera</span><span class="o">.</span><span class="n">toleration</span><span class="o">.</span><span class="n">Toleration</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NODE_TOLERATION_KEY'</span><span class="p">),</span> <span class="n">operator</span><span class="o">=</span><span class="s1">'Equal'</span><span class="p">,</span> <span class="n">effect</span><span class="o">=</span><span class="s1">'NoSchedule'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NODE_TOLERATION_VALUE'</span><span class="p">)),</span>
        <span class="n">hera</span><span class="o">.</span><span class="n">toleration</span><span class="o">.</span><span class="n">Toleration</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">'kubernetes.azure.com/scalesetpriority'</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">'Exists'</span><span class="p">,</span> <span class="n">effect</span><span class="o">=</span><span class="s1">'NoSchedule'</span><span class="p">)</span>
    <span class="p">]</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">hera</span><span class="o">.</span><span class="n">workflow</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">'unique-name-of-workflow'</span><span class="p">,</span>
    <span class="n">image_pull_secrets</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'REGISTRY_PULL_SECRET'</span><span class="p">)],</span>
    <span class="n">node_selectors</span><span class="o">=</span><span class="n">node_selectors</span><span class="p">,</span>
    <span class="n">tolerations</span><span class="o">=</span><span class="n">tolerations</span><span class="p">,</span>
    <span class="n">service_account_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_SA'</span><span class="p">),</span>
    <span class="n">parallelism</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># Number of tasks to run in parallel </span>
<span class="p">)</span>
</pre></div>
</div>
<p>Define your tasks and add them to the current workflow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">some_func</span><span class="p">():</span>
  <span class="kn">import</span> <span class="nn">os</span>
  <span class="c1">#do something</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'TASKSAY'</span><span class="p">))</span>

<span class="c1"># Environment Variables for running source/container</span>
<span class="n">env_list</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">hera</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'SOME_ENV'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">'SOME_VAL'</span><span class="p">),</span>
  <span class="n">hera</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">Env</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'TASKSAY'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">'Workflows Are Powerful!'</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Task using a function as input</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">hera</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">'source-task'</span><span class="p">,</span>
  <span class="n">image</span><span class="o">=</span><span class="s1">'registry.eo4ph.geoanalytics.ca/project-name/image-name:image-tag'</span><span class="p">,</span>
  <span class="n">source</span><span class="o">=</span><span class="n">some_func</span><span class="p">,</span>
  <span class="n">node_selectors</span><span class="o">=</span><span class="n">node_selectors</span><span class="p">,</span>
  <span class="n">tolerations</span><span class="o">=</span><span class="n">tolerations</span><span class="p">,</span>
  <span class="n">env</span><span class="o">=</span><span class="n">env_list</span>
<span class="p">)</span>

<span class="c1"># Task using a prebuilt Docker Image running some Python application</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">hera</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">'container-task'</span><span class="p">,</span>
  <span class="n">image</span><span class="o">=</span><span class="s1">'registry.eo4ph.geoanalytics.ca/project-name/image-name:image-tag'</span>
  <span class="n">command</span><span class="o">=</span><span class="p">[</span><span class="s1">'/bin/bash'</span><span class="p">,</span> <span class="s1">'-c'</span><span class="p">,</span> <span class="s1">'python run.py'</span><span class="p">],</span>
  <span class="n">node_selectors</span><span class="o">=</span><span class="n">node_selectors</span><span class="p">,</span>
  <span class="n">tolerations</span><span class="o">=</span><span class="n">tolerations</span><span class="p">,</span>
  <span class="n">env</span><span class="o">=</span><span class="n">env_list</span>
<span class="p">)</span>

<span class="n">w</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="c1"># Add source-task to workflow</span>
<span class="n">w</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span> <span class="c1"># Add container-task to workflow</span>
<span class="n">t1</span> <span class="o">&gt;&gt;</span> <span class="n">t2</span> <span class="c1"># DAG - make t1 run before t2</span>
</pre></div>
</div>
<p>Build and submit your workflow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ws</span><span class="o">.</span><span class="n">create_workflow</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">build</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="couler">
<h3>Couler<a class="headerlink" href="#couler" title="Permalink to this headline">#</a></h3>
<p>Couler is a generic Pipeline framework that aims to interact with
all Pipeline engines - currently only Argo is supported.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pipeline_job</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">env_user</span><span class="p">):</span>
    <span class="n">toleration</span> <span class="o">=</span> <span class="n">Toleration</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NODE_TOLERATION_KEY'</span><span class="p">),</span> <span class="s1">'NoSchedule'</span><span class="p">,</span> <span class="s1">'Exists'</span><span class="p">)</span>
    <span class="n">couler</span><span class="o">.</span><span class="n">add_toleration</span><span class="p">(</span><span class="n">toleration</span><span class="p">)</span>
    <span class="n">toleration2</span> <span class="o">=</span> <span class="n">Toleration</span><span class="p">(</span><span class="s1">'kubernetes.azure.com/scalesetpriority'</span><span class="p">,</span> <span class="s1">'NoSchedule'</span><span class="p">,</span> <span class="s1">'Exists'</span><span class="p">)</span>
    <span class="n">couler</span><span class="o">.</span><span class="n">add_toleration</span><span class="p">(</span><span class="n">toleration2</span><span class="p">)</span>
    <span class="n">image_secret</span> <span class="o">=</span> <span class="n">ImagePullSecret</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'REGISTRY_PULL_SECRET'</span><span class="p">))</span>
    <span class="n">couler</span><span class="o">.</span><span class="n">add_image_pull_secret</span><span class="p">(</span><span class="n">image_secret</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">couler</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span>
        <span class="n">image</span><span class="o">=</span><span class="s2">"registry.eo4ph.geoanalytics.ca/project-name/image-name:image-tag"</span><span class="p">,</span>
        <span class="n">step_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env_user</span><span class="p">,</span>
        <span class="n">node_selector</span><span class="o">=</span><span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NODE_SELECTOR_KEY'</span><span class="p">):</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NODE_SELECTOR_VALUE'</span><span class="p">)},</span>
        <span class="n">secret</span><span class="o">=</span><span class="n">image_secret</span>
    <span class="p">)</span>

<span class="c1"># Some environment variables for the Job Task</span>
<span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'some-env'</span><span class="p">:</span> <span class="s1">'env-value'</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">user_function</span><span class="p">():</span>
  <span class="c1"># Do Something</span>

<span class="k">def</span> <span class="nf">create_job</span><span class="p">():</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">couler</span><span class="o">.</span><span class="n">set_dependencies</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">pipeline_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'job1'</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">user_function</span><span class="p">,</span> <span class="n">env_user</span><span class="o">=</span><span class="n">env</span><span class="p">),</span>
        <span class="n">dependencies</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

<span class="n">create_job</span><span class="p">()</span>
<span class="n">submitter</span> <span class="o">=</span> <span class="n">ArgoSubmitter</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'WORKFLOW_NS'</span><span class="p">))</span>
<span class="n">deployment</span> <span class="o">=</span> <span class="n">couler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">submitter</span><span class="o">=</span><span class="n">submitter</span><span class="p">)</span>
<span class="n">deployment</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2023, Hatfield Consultants
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Docker &amp; Pipelines</a><ul>
<li><a class="reference internal" href="#useful-links">Useful Links</a></li>
<li><a class="reference internal" href="#environtment-variables">Environtment Variables</a></li>
<li><a class="reference internal" href="#docker-in-the-remote-desktop">Docker in the Remote Desktop</a></li>
<li><a class="reference internal" href="#using-docker-and-pipelines">Using Docker and Pipelines</a></li>
<li><a class="reference internal" href="#example-project">Example Project</a></li>
<li><a class="reference internal" href="#dockerfile">Dockerfile</a></li>
<li><a class="reference internal" href="#building-and-pushing-to-the-container-registry">Building and Pushing to the Container Registry</a></li>
<li><a class="reference internal" href="#using-your-docker-image-in-a-pipeline">Using Your Docker Image in a Pipeline</a><ul>
<li><a class="reference internal" href="#hera-workflows">Hera-Workflows</a></li>
<li><a class="reference internal" href="#couler">Couler</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>