<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="prev" title="Scientific Workflows" href="index.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.06.04.1"/>
        <title>Daily NDSI Average Pipeline - GEOAnalytics Canada</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">GEOAnalytics Canada</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/geoanalytics-icon.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">GEOAnalytics Canada</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Welcome</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../1_getting_started/index.html">Getting Started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/02-geospatial-python.html"><strong>Working with Earth Observation data in Python</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/03-jupyter-notebooks.html"><strong>Jupyter Notebooks</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/04-authentication.html"><strong>Authentication</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/05-desktop-vm.html"><strong>Desktop VM’s</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/06-file-browser.html"><strong>File Browser</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/07-stac.html"><strong>SpatioTemporal Asset Catalog (STAC)</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/08-gitlab.html"><strong>GitLab</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/09-pipelines.html"><strong>Pipelines</strong></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2_real_world_examples/index.html">Real World Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/01-accessing-data.html"><strong>Accessing and Downloading Data</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/02-ndvi-with-dask.html"><strong>NDVI With Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/03-ndsi-with-dask.html">1. Initialize your Dask Gateway Clusters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/03-ndsi-with-dask.html#2.-Getting-the-MODIS-Data">2. Getting the MODIS Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/03-ndsi-with-dask.html#3.-Calculating-the-NDSI">3. Calculating the NDSI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/03-ndsi-with-dask.html#4.-Visualizing-the-Results">4. Visualizing the Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/04-ndwi-with-dask.html"><strong>NDWI With Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/05-change-detection.html"><strong>Change Detection</strong></a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Scientific Workflows</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#"><strong>Daily NDSI Average Pipeline</strong></a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Daily-NDSI-Average-Pipeline">
<h1><strong>Daily NDSI Average Pipeline</strong><a class="headerlink" href="#Daily-NDSI-Average-Pipeline" title="Permalink to this headline">#</a></h1>
<p>FLNRO-esque demonstrates the workflow for gathering data products that are specific to an application and how to leverage those into an informative product that can affect real-world decisions, making use of powerful tools such as Kubeflow.</p>
<p>In this tutorial notebook, we will build a Kubeflow Pipeline which will process the Modis Snow Product over the previous 5 to 8 days (depending on user input) and return the visualization of the NDSI Average in British Columbia, Canada.</p>
<p>The main steps for creating the Daily NDSI Average Pipeline:</p>
<ol class="arabic simple">
<li><p>Query MODIS snow product (MOD10A1.001) data using a bounding box AOI and date ranges</p></li>
<li><p>Threshold the NDSI</p></li>
<li><p>Create mosaics from raw MODIS granules by merging different tiles together</p></li>
<li><p>Compute the NDSI average over the date range</p></li>
<li><p>Visualize the NDSI averages</p></li>
</ol>
<p>All these steps for this tutorial will be separated into pipeline components, based on Python functions we will implement.</p>
<p><strong>First, run the following command to install all the packages and dependencies required for this tutorial</strong>. The requirements.txt file contains the Python CMR API for data querying, and the Kubeflow Pipelines SDK and lxml (a Python library which allows for easy handling of XML and HTML files, and can also be used for web scraping).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>! pip install -r data/requirements_6.txt
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os
import sys
import time
import io
import yaml
import json
import logging
import getpass
import requests

import kfp

import kfp.dsl as dsl
import kfp.gcp as gcp

from lxml import html
from google.cloud import storage
from kubernetes import client
from kubernetes.client import V1Toleration
from kfp.components import InputPath, OutputPath, create_component_from_func
from urllib.request import urlopen, Request, build_opener, HTTPCookieProcessor
</pre></div>
</div>
</div>
<section id="1.-Connect-to-Kubeflow-Client">
<h2>1. Connect to Kubeflow Client<a class="headerlink" href="#1.-Connect-to-Kubeflow-Client" title="Permalink to this headline">#</a></h2>
<p>To create a pipeline, we must first connect to GEOAnalytics’ Kubeflow Pipeline Client. Please run the cell below and enter your GEOAnalytics username and password to authenticate the client.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>### GEOAnalyticsKubeflowClient

class GEOAnalyticsKubeflowClient:
    def __init__(self, username, password, auth_provider, namespace=None):
        self.logger = None
        self._initialize_logger()

        self.client = None
        self.namespace = username if namespace is None else namespace

        self._authenticate(username, password, auth_provider)
        self._validate_client_connection()

    def _initialize_logger(self):
        logging.basicConfig(format=&#39;%(asctime)s %(levelname)s (%(name)s): %(message)s&#39;, level=logging.INFO, datefmt=&#39;%Y-%m-%d %H:%M:%S&#39;)
        self.logger = logging.getLogger(&quot;GEOAnalyticsKubeflowClient&quot;)

    # https://github.com/kubeflow/kfctl/issues/140#issuecomment-719894529
    def _authenticate(self, username, password, auth_provider):
        session = requests.Session()
        response = session.get(auth_provider.host)
        headers = {
            &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,
        }

        data = auth_provider.get_auth_data_dict(username, password)
        post_url = auth_provider.get_auth_post_url(response)
        session.post(post_url, headers=headers, data=data)
        try:
            session_cookie = session.cookies.get_dict()[&quot;authservice_session&quot;]
        except Exception as e:
            message = &quot;invalid host or credentials&quot;
            self.logger.error(message)
            raise Exception(message) from None

        self.client = kfp.Client(
            host=f&quot;{auth_provider.host}/pipeline&quot;,
            cookies=f&quot;authservice_session={session_cookie}&quot;,
            namespace=self.namespace,
        )


    def _validate_client_connection(self):
        if self.client.list_pipelines().total_size &gt; 0:
            self.logger.info(&quot;successfully authenticated with kubeflow&quot;)
        else:
            message = &quot;unable to validate kubeflow client connection. listing pipelines failed.&quot;
            self.logger.error(message)
            raise Exception(message)

class DexProvider:
    def __init__(self, host):
        self.host = host
        self.name = &quot;dex&quot;

    def get_auth_data_dict(self, username, password):
        return {&quot;login&quot;: username, &quot;password&quot;: password}

    def get_auth_post_url(self, initial_response):
        return initial_response.url

    def get_provider_name(self):
        return self.name
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>provider = DexProvider(&quot;http://kubeflow.geoanalytics.ca&quot;)
kubeflow_client = GEOAnalyticsKubeflowClient(input(&quot;Username: &quot;), getpass.getpass(), provider)
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Username:  asaini
 ············
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2021-09-08 19:35:27 INFO (GEOAnalyticsKubeflowClient): successfully authenticated with kubeflow
</pre></div></div>
</div>
<p>Now, before we can move forward to building our functions, make sure you have an <strong>existing NASA EarthData account</strong>. We require authentication for retrieving the MODIS data in this example. If you do not have an EarthData account yet, you can create it for free here: <a class="reference external" href="https://urs.earthdata.nasa.gov/home">https://urs.earthdata.nasa.gov/home</a></p>
<p>Then, enter in your <strong>username</strong> and <strong>password</strong> in the cell input below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>username = input()
password = getpass.getpass()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 asaini
 ·············
</pre></div></div>
</div>
</section>
<section id="2.-Implementing-the-Python-Functions">
<h2>2. Implementing the Python Functions<a class="headerlink" href="#2.-Implementing-the-Python-Functions" title="Permalink to this headline">#</a></h2>
<p>Once we have our authentications ready, let’s move on and create the functions. The python functions will implement the steps for the working pipeline, which will be converted to components using the <code class="docutils literal notranslate"><span class="pre">kfp.components.create_component_from_func(&lt;python</span> <span class="pre">function&gt;,</span> <span class="pre">&lt;base</span> <span class="pre">image&gt;)</span></code>. The custom Docker image, stored at <em>‘registry.geoanalytics.ca/examples/modis-ndsi’</em>, is already created with all the necessary packages and files installed, ready for you to use.</p>
<section id="2.1-Querying-Data-Function">
<h3>2.1 Querying Data Function<a class="headerlink" href="#2.1-Querying-Data-Function" title="Permalink to this headline">#</a></h3>
<p>The first step of the process to to collect information about the data we want. Given the number of most recent days and an area of interest, the function must output a list of granules URLs.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Creates a EarthData client passing in the username and password collected in above, using Hatfield CMR.</p></li>
<li><p>Opens the polygon shapefile (saved in our Docker image) and uses its bounds as the area of interest.</p></li>
<li><p>Creates a date range based on the days provided.</p></li>
<li><p>Queries for granules matching the provided requirements.</p></li>
<li><p>Separate URLs of granules into sublists according to their dates.</p></li>
<li><p>Return the list of lists.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def query_modis_data(days: int, polygon: str, earthdata_user: str, earthdata_pass: str) -&gt; list:
    import datetime
    import json
    import re
    import glob
    import geopandas as gpd
    from hatfieldcmr import CMRClient

    # Create earthdata client
    ed_client = CMRClient(None, earthdata_user, earthdata_pass)

     # Query for granule metadata from NASA CMR
    bc = gpd.read_file(glob.glob(polygon + &#39;/*.shp&#39;)[0])
    bounding_box = bc.bounds.values[0]
    # End date is 4 days ago from current date to allow enough time for correctly processed data
    end_date = datetime.date.today() - datetime.timedelta(4)
    start_date = end_date - datetime.timedelta(days-1)
    product = &#39;MOD10A1.6&#39;

    granules = ed_client.query(str(start_date), str(end_date), product, bbox=bounding_box)
    print(f&quot;Retrieved {len(granules)} granules from query&quot;)

    # Separate urls of granules into sublists according to dates
    urls_list = []
    sublist = []

    get_date = re.search(&#39;\d{4}\d{3}&#39;, granules[0][&#39;links&#39;][0][&#39;href&#39;])
    prev_date = datetime.datetime.strptime(get_date.group(), &#39;%Y%j&#39;).date()

    for file in granules:
        url = file[&#39;links&#39;][0][&#39;href&#39;]
        get_date = re.search(&#39;\d{4}\d{3}&#39;, url)
        new_date = datetime.datetime.strptime(get_date.group(), &#39;%Y%j&#39;).date()

        # Condition to separate to a different sublist: if date is different or its the last granule in the list
        if new_date != prev_date or file == granules[-1]:
            sublist_json = json.dumps(sublist)
            urls_list.append(sublist_json)
            prev_date = new_date
            sublist =[]
            continue

        sublist.append(url)

    # Serializing json
    urls_list_json = json.dumps(urls_list)
    return urls_list_json


query_modis_data_op = create_component_from_func(query_modis_data,base_image=&#39;registry.geoanalytics.ca/examples/modis-ndsi&#39;)
</pre></div>
</div>
</div>
</section>
<section id="2.2-Thresholding-and-Creating-Mosaic-Function">
<h3>2.2 Thresholding and Creating Mosaic Function<a class="headerlink" href="#2.2-Thresholding-and-Creating-Mosaic-Function" title="Permalink to this headline">#</a></h3>
<p>The function <code class="docutils literal notranslate"><span class="pre">create_mosaics()</span></code> combines the two steps of thresholding the NDSI of each granule, and combining same date granules together.</p>
<p>The inputs of this function are the sublist of urls of the same date, EarthData credentials, the polygon of British Columbia, and the path to our GEOAnalytics bucket where our generated mosaics will stored.</p>
<p>We will be using the MOD10A Version 6 Product which included the computed NDSI Snow Cover values. The NDSI formula is the normalized difference between highly Visible (VIR) and Shortwave Infrared (SWIR) bands. We will need to threshold to make sure to separate the snow-covered pixels from no-snow pixels. Pixels with values between 20 and 100 are considered <strong>Snow Pixels</strong>.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the Google Cloud Storage File System (GCSFS) API’s credentials for accessing our buckets.</p>
<ul>
<li><p>Token is the secret key JSON file which is loaded into the Docker container.</p></li>
</ul>
</li>
<li><p>Create an EarthData Client.</p></li>
<li><p>Iterates through each URL in the list of URLS (of the same date)</p>
<ul>
<li><p>Using the Hatfield CMR, stream in the granule into a temporary file.</p></li>
<li><p>Threshold the NDSI (Snow pixels set to 1, otherwise 0).</p></li>
<li><p>Append the updated DataArray to a list.</p></li>
</ul>
</li>
<li><p>Merge the list of DataArrays together.</p></li>
<li><p>Reproject the merged array to the same Coordinate Reference System (CRS) as the BC Polygon.</p></li>
<li><p>Clip the mosaic to the polygon.</p></li>
<li><p>Write the mosaic raster to a local file.</p></li>
<li><p>Copy the contents from the local file to a folder for the current date on Google Cloud.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def create_mosaics(urls: list, earthdata_user: str, earthdata_pass: str, polygon: str, gcs_paths: str) -&gt; OutputPath(str):
    import datetime
    import re
    import glob
    import tempfile
    import rasterio
    import gcsfs
    import geopandas as gpd
    import numpy as np
    import rioxarray as rxr
    import xarray as xr
    from hatfieldcmr import CMRClient
    from urllib.request import urlopen, Request, build_opener, HTTPCookieProcessor
    from rioxarray.merge import merge_arrays

    # Set up the gcsfs system with credentials
    tok = &#39;/secret/gcp-credentials/geoanalytics-canada-kubeflow.json&#39;
    tok_dict = json.load(open(tok))
    gcs = gcsfs.GCSFileSystem(token=tok_dict, access=&#39;read_write&#39;)

    # Create earthdata client
    ed_client = CMRClient(None, earthdata_user, earthdata_pass)

    today = datetime.date.today()
    downloads = []
    for url in urls:
        # Get date for file naming
        get_date = re.search(&#39;\d{4}\d{3}&#39;, url)
        date = datetime.datetime.strptime(get_date.group(), &#39;%Y%j&#39;).date()

        # Stream in the current granule
        buff = ed_client.download_earthdata_file(url, (earthdata_user, earthdata_pass)) # download the image into memory
        with tempfile.NamedTemporaryFile() as tmpfile:
            tmpfile.write(buff.getvalue())
            with rxr.open_rasterio(tmpfile.name, &#39;r&#39;) as src:
                ndsi = src.NDSI_Snow_Cover
                # Threshold NDSI
                ndsi.data[(ndsi.data &gt; 100)] = 0
                ndsi.data[(ndsi.data &lt; 20)] = 0
                ndsi.data[(ndsi.data != 0)] = 1
                ndsi.data = ndsi.data.astype(np.uint8)

        downloads.append(ndsi)

    #Merge granules together into a mosaic
    ds = merge_arrays(downloads)
    print(&#39;Dataset size (Gb): &#39;, ds.nbytes/1e9)

    # Reproject and crop to the polygon
    bc = gpd.read_file(glob.glob(polygon + &#39;/*.shp&#39;)[0])
    bounding_box = bc.bounds.values[0]
    ds = ds.rio.reproject(bc.crs)
    ds = ds.rio.clip_box(*bounding_box)
    print(&#39;Dataset size (Gb): &#39;, ds.nbytes/1e9)

    file = f&#39;{date}.tif&#39;
    ds.rio.to_raster(file, recalc_transform=True)

    # Saving to GCP
    output_path = f&#39;{gcs_paths}{today}/mosaics/{date}.tif&#39;
    gcs.put(file, output_path)

    return output_path

create_mosaics_op = create_component_from_func(create_mosaics, base_image=&#39;registry.geoanalytics.ca/examples/modis-ndsi&#39;)
</pre></div>
</div>
</div>
</section>
<section id="2.3-Computing-Average-NDSI-Function">
<h3>2.3 Computing Average NDSI Function<a class="headerlink" href="#2.3-Computing-Average-NDSI-Function" title="Permalink to this headline">#</a></h3>
<p>Once the mosaics for all the dates are created, the next step will require a function which stacks these mosaics and calculates the average NDSI value of the mosaics. The GCS path will be passed in as input, pointing to where all the mosaics are stored.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the GCSFS credentials for accessing the bucket (same as in previous function)</p></li>
<li><p>Iteratively search for and save the dimensions and shape of the mosaic with the smallest size.</p>
<ul>
<li><p>All mosaic arrays must be same size to be stacked together.</p></li>
</ul>
</li>
<li><p>Resize all mosaics to the saved shape.</p></li>
<li><p>Make sure the number of mosaics equals to the number of days that are requested.</p></li>
<li><p>Stack the mosaics together.</p></li>
<li><p>Compute the mean over all the mosaics.</p></li>
<li><p>Place the averaged mosaics in a DataArray with the saved dimensions.</p></li>
<li><p>Write the mosaic raster to a local file.</p></li>
<li><p>Copy the contents from the local file into the same location where the mosaics are stored.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def average_ndsi(gcs_paths: str, days: int) -&gt; str:
    import datetime
    import glob
    import json
    import gcsfs
    import rasterio
    import numpy as np
    import rioxarray as rxr
    import xarray as xr

     # Set up the gcsfs system with credentials
    tok = &#39;/secret/gcp-credentials/geoanalytics-canada-kubeflow.json&#39;
    tok_dict = json.load(open(tok))
    gcs = gcsfs.GCSFileSystem(token=tok_dict, access=&#39;read_write&#39;)

    today = datetime.date.today()
    mosaics = gcs.glob(f&#39;{gcs_paths}{today}/mosaics/&#39;)

    # Arbitrary variables to be replaced
    _dims_x = None
    _dims_y = None
    _shape = (1, 100000, 100000)

    # Get the shape of the smallest mosaic for stacking
    for mosaic in mosaics:
        if not(mosaic.endswith(&#39;.tif&#39;)):
            continue
        with gcs.open(mosaic) as fobj:
            with rasterio.open(fobj) as dataset:
                ndsi = xr.open_rasterio(dataset)
                if ndsi.shape &lt; _shape:
                    _shape = ndsi.shape
                    _dims_x = ndsi[&#39;x&#39;]
                    _dims_y = ndsi[&#39;y&#39;]

    # Resize all the mosaics to the size of the smallest one
    arrs = []
    for mosaic in mosaics:
        if not(mosaic.endswith(&#39;.tif&#39;)):
            continue
        with gcs.open(mosaic) as fobj:
            with rasterio.open(fobj) as dataset:
                ndsi = xr.open_rasterio(dataset)
                ndsi.data[(ndsi.data &gt; 100)] = 0
                arrs.append(ndsi.data[:,0:_shape[1],0:_shape[2]])
    # Assert that the number of mosaics matches the days requested
    assert(len(arrs) == days)

    stk = np.stack(arrs, axis=0)  # stacking
    stk = stk.squeeze()           # squeezing
    stk_mn = np.mean(stk, axis=0) # averaging

    # Combining and returning the DataArray
    ds = xr.DataArray(data=stk_mn, coords=(_dims_y,_dims_x))

    file = &#39;average_ndsi.tif&#39;
    ds.rio.to_raster(file, recalc_transform=True)

    # Saving to GCP
    output_path = f&#39;{gcs_paths}{today}/{file}&#39;
    gcs.put(file, output_path)

    return output_path

average_ndsi_op = create_component_from_func(average_ndsi, base_image=&#39;registry.geoanalytics.ca/examples/modis-ndsi&#39;)
</pre></div>
</div>
</div>
</section>
<section id="2.4-Plotting-the-Final-NDSI-Function">
<h3>2.4 Plotting the Final NDSI Function<a class="headerlink" href="#2.4-Plotting-the-Final-NDSI-Function" title="Permalink to this headline">#</a></h3>
<p>Once the mosaics for all the dates are created, the next step will require a function which stacks these mosaics and calculates the average NDSI value of the mosaics. The GCS path will be passed in as input, pointing to where all the mosaics are stored.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the GCSFS credentials for accessing the bucket.</p></li>
<li><p>Load in the average NDSI tiff stored in GCS.</p></li>
<li><p>Crop to the BC Polygon shape.</p></li>
<li><p>Plot the image with the boundary of BC outlining the edges.</p></li>
<li><p>Save the figure as a temporary binary file.</p></li>
<li><p>Encode to base64 so it can be shown as in image source in HTML as a “Pipeline Output Artifact.”</p></li>
<li><p>Write the metadata for the output viewer and save as a metadata file.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_ndsi(final_ndsi: str, polygon: str, days: int, mlpipeline_ui_metadata_path: OutputPath()):
    import glob
    import json
    import gcsfs
    import datetime
    import rasterio
    import base64
    import rioxarray as rxr
    import geopandas as gpd
    import xarray as xr
    import numpy as np
    import matplotlib.pyplot as plt
    from io import BytesIO
    from shapely.geometry import mapping

     # Set up the gcsfs system with credentials
    tok = &#39;/secret/gcp-credentials/geoanalytics-canada-kubeflow.json&#39;
    tok_dict = json.load(open(tok))
    gcs = gcsfs.GCSFileSystem(token=tok_dict, access=&#39;read_write&#39;)

    # Load in the tiff file from GCS as a DataArray and crop to BC
    with gcs.open(final_ndsi) as fobj:
            with rasterio.open(fobj) as dataset:
                ndsi = rxr.open_rasterio(dataset)
                bc = gpd.read_file(glob.glob(polygon + &#39;/*.shp&#39;)[0])
                ndsi = ndsi.rio.write_crs(bc.crs)
                ndsi = ndsi.rio.clip(bc.geometry.apply(mapping), bc.crs)

    # Plot the image
    f, ax = plt.subplots(figsize=(16, 8))
    ndsi[0].plot.imshow(ax=ax, cmap=plt.cm.RdYlBu, vmin=0, vmax=1, clim=[0,1])
    bc.boundary.plot(ax=ax, alpha=.8, edgecolor=&quot;black&quot;)#, facecolor=&quot;None&quot;)
    ax.set(title=f&quot;NDSI average over {days} days&quot;)

    # Save image as a binary temp file to be encoded to base64
    tmpfile = BytesIO()
    plt.savefig(tmpfile, format=&#39;png&#39;)
    encoded = base64.b64encode(tmpfile.getvalue()).decode(&#39;utf-8&#39;)

    html = &#39;&lt;img src=\&#39;data:image/png;base64,{}\&#39;&gt;&#39;.format(encoded)

    metadata = {
    &#39;outputs&#39; : [
    {
      &#39;source&#39;: html,
      &#39;storage&#39;: &#39;in-line&#39;,
      &#39;type&#39;: &#39;markdown&#39;,
    }]}

    with open(mlpipeline_ui_metadata_path, &#39;w&#39;) as metadata_file:
        json.dump(metadata, metadata_file)

plot_ndsi_op = create_component_from_func(plot_ndsi, base_image=&#39;registry.geoanalytics.ca/examples/modis-ndsi&#39;)
</pre></div>
</div>
</div>
<p><strong>Pipeline Output Artifact:</strong> The Kubeflow Pipelines UI provides built-in support for many types of visualizations. The current available <em>Output Viewers</em> are Confusion matrix, Markdown, ROC curve, Table, TensorBoard, and Web app. For our example, we want to output a final Raster image using matplotlib, so the output viewers we can use are Markdown or <strong>Web app.</strong> These will allow us to pass in static HTML code that can be displayed in the Output Artifacts.</p>
</section>
<section id="2.5-Delete-Files-Function">
<h3>2.5 Delete Files Function<a class="headerlink" href="#2.5-Delete-Files-Function" title="Permalink to this headline">#</a></h3>
<p>Since our pipeline stores the files we’ve created for today and this is a Daily NDSI Average Pipeline, it is unnecessary to keep the data once we have the final result. The function <code class="docutils literal notranslate"><span class="pre">delete_files()</span></code> will permanently remove the folder for today’s date containing all the data stored in the GEOAnalytic’s Google Cloud bucket.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the GCSFS credentials for accessing the bucket.</p></li>
<li><p>Access the folder for today’s date within the GCS bucket.</p></li>
<li><p>Check if files exist within this folder.</p></li>
<li><p>Check if the folder contains subfolders.</p>
<ul>
<li><p>Delete files from the subfolder.</p></li>
</ul>
</li>
<li><p>Delete all files from the folder (This will implicitly delete the empty folder itself).</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def delete_files(gcs_paths: str, mlpipeline_ui_metadata_path: OutputPath()):
    import json
    import gcsfs
    import glob
    import datetime

     # Set up the gcsfs system with credentials
    tok = &#39;/secret/gcp-credentials/geoanalytics-canada-kubeflow.json&#39;
    tok_dict = json.load(open(tok))
    gcs = gcsfs.GCSFileSystem(token=tok_dict, access=&#39;read_write&#39;)

    # Access the directory with files created for today&#39;s run
    today = datetime.date.today()

    main_folder = gcs_paths + str(today)
    cond = gcs.exists(main_folder)
    if cond:
        folder = gcs.ls(main_folder)
        for file in folder:
            subfolder = gcs.ls(file)
            if len(subfolder) &gt; 1:  # If the object is a subfolder
                empty_subfile = [gcs.rm(x) for x in subfolder] # Delete all files in subfolder
            gcs.rm(file) # Delete other files in the main folder

delete_files_op = create_component_from_func(delete_files, base_image=&#39;registry.geoanalytics.ca/examples/modis-ndsi&#39;)
</pre></div>
</div>
</div>
</section>
</section>
<section id="3.-Assembling-the-Pipeline">
<h2>3. Assembling the Pipeline<a class="headerlink" href="#3.-Assembling-the-Pipeline" title="Permalink to this headline">#</a></h2>
<p>Once we have our components ready, the next step is to put them together in a pipeline. The Daily NDSI Pipeline will take the arguments for the number of days you want an average over, your EarthData username and password, the path to the polygon shapefile (this file is already downloaded in the base image), and the GCS path where files will be stored.</p>
<p>Now there are two important variables to notice:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">custom_nodepool</span></code> which is an operator that configures the Google Kubernetes Engine (GKE) preemptible in a container op, custom to this tutorial.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gcp_key</span></code>, an operator to configure the container to use Google Cloud Platform (GCP) service account by service account key stored in a Kubernetes secret. This allows us to read and write to GEOAnalytics GCS buckets.</p></li>
</ul>
<p>Applying these operators to the components will allow the pipeline to run smoothly. We will also set the CPI request at 3.5 and memory request at 11,000 MB to enforce operations running on individual pods.</p>
<ol class="arabic simple">
<li><p>The first component to be called in the converted <code class="docutils literal notranslate"><span class="pre">query_modis_data</span></code> function.</p></li>
<li><p>The next step is to threshold the NDSI and combine the rasters for the same date in a mosaic using <code class="docutils literal notranslate"><span class="pre">create_mosaic</span></code>. To efficiently do this, we will use the <code class="docutils literal notranslate"><span class="pre">dsl.ParallelFor</span></code> loop which will run the process operation on different pods, where each pod will take sublist of the list of granule URLs as input. i.e. Each pod will process granules of a different date, so the number of pods should be equivalent to the number of days passed in.</p></li>
<li><p>After we have the mosaics created, we will compute the average of the NDSI with our <code class="docutils literal notranslate"><span class="pre">average_ndsi_op</span></code> operation. the <code class="docutils literal notranslate"><span class="pre">.after(processOp)</span></code> method constrains the operation to start once the previous parallel operations are complete.</p></li>
<li><p>Finally, passing in the output path from the previous operation to the averaged GeoTIFF, we can plot the final image.</p></li>
<li><p>An optional step is to delete the files created and stored within the GCS. If you want to take a look at the saved files, the mosaics and the final average NDSI (all GeoTIFFs), then simply comment out the <code class="docutils literal notranslate"><span class="pre">deleteOp</span></code>.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>@dsl.pipeline(
  name=&#39;MOD10A1 Daily NDSI Average Processing Pipeline&#39;,
  description=&#39;A pipeline that processes the daily Normalized Difference Snow Index in British Columbia given a time range.&#39;
)
def daily_ndsi_pipeline(days: int, earthdata_user: str, earthdata_pass: str, polygon: str, gcs_paths: str):

    custom_nodepool = gcp.use_preemptible_nodepool(V1Toleration(key=&#39;daily-ndsi-processing&#39;, operator=&#39;Exists&#39;))
    gcp_key = gcp.use_gcp_secret(secret_name=&#39;user-gcp-sa&#39;, secret_file_path_in_volume=&#39;/geoanalytics-canada-kubeflow.json&#39;)

    # 1. Fetch the URLs of our MODIS data from the query
    fetchOp = query_modis_data_op(days,
                                  polygon,
                                  earthdata_user,
                                  earthdata_pass
                                 ).apply(custom_nodepool)#.set_cpu_request(&#39;3.5&#39;).set_memory_request(&#39;11000M&#39;)

    # 2. &quot;Download&quot; the data and create mosaics stored in a list
    with dsl.ParallelFor(fetchOp.output) as item:
        processOp = create_mosaics_op(item,
                                      earthdata_user,
                                      earthdata_pass,
                                      polygon,
                                      gcs_paths
                                     ).apply(custom_nodepool).apply(gcp_key).set_cpu_request(&#39;3.5&#39;).set_memory_request(&#39;11000M&#39;).set_retry(3)

    # 3. Get average of the all the mosaics
    combineOp = average_ndsi_op(gcs_paths,
                               days).after(processOp).apply(custom_nodepool).apply(gcp_key)#.set_cpu_request(&#39;3.5&#39;).set_memory_request(&#39;11000M&#39;).set_retry(3)

    # 4. Plot the average (input is an Xarray DataArray)
    plottingOp = plot_ndsi_op(combineOp.output,
                              polygon,
                              days).apply(custom_nodepool).apply(gcp_key)#.set_cpu_request(&#39;3.5&#39;).set_memory_request(&#39;11000M&#39;).set_retry(3)

     # 5. Delete files from GCS
    deleteOp = delete_files_op(gcs_paths).after(plottingOp).apply(custom_nodepool).apply(gcp_key)#.set_cpu_request(&#39;3.5&#39;).set_memory_request(&#39;11000M&#39;).set_retry(3)

    # Configurations for the pipeline to run in the specific nodepool and allowing access to GEOAnalytics&#39; container Rrgistry
    dsl.get_pipeline_conf().set_default_pod_node_selector(&#39;app.geoanalytics.ca/nodepool&#39;, &#39;daily-ndsi-processing&#39;)
    dsl.get_pipeline_conf().set_image_pull_secrets([client.V1LocalObjectReference(name=&quot;regcredgeoanalytics&quot;)])
<br/></pre></div>
</div>
</div>
<p>Let’s compile the pipeline with the name <strong>“Average NDSI Pipeline!”</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># COMPILE PIPELINE #
pipeline_name = &quot;Average NDSI Pipeline!&quot;
pipeline_func = daily_ndsi_pipeline
pipeline_filename = pipeline_func.__name__ + &#39;.yaml&#39;
kfp.compiler.Compiler().compile(pipeline_func, pipeline_filename)
</pre></div>
</div>
</div>
<p>The arguments we will pass in below are to be used for the Run. The username and password will be what you entered above in Section 1, and you can modify the days parameter to any reasonable integer. The polygon and gcs_paths should stay the same as they are hardcoded for this tutorial example.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>arguments = {
    &#39;days&#39;: 8,
    &#39;earthdata_user&#39;: username,
    &#39;earthdata_pass&#39;: password,
    &#39;polygon&#39;: &#39;/bc-polygon&#39;,
    &#39;gcs_paths&#39;: &#39;gcs://geoanalytics-user-shared-data/tutorial_data/&#39;
}
</pre></div>
</div>
</div>
<p>Finally, let’s run and upload the pipeline!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>count=1 # only run once
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># If the experiment under the given name already exists - get it&#39;s ID, else - create a new experiment
try:
    experiment_id = kubeflow_client.client.get_experiment(&quot;daily-avg-ndsi&quot;)
except:
    experiment = kubeflow_client.client.create_experiment(&quot;daily-avg-ndsi&quot;)
run_name = pipeline_func.__name__ + f&#39;-run#{count}&#39;
run_result = kubeflow_client.client.run_pipeline(experiment.id, run_name, pipeline_filename, arguments)
count += 1
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2021-09-08 19:36:44 INFO (root): Creating experiment daily-avg-ndsi.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<a href="http://kubeflow.geoanalytics.ca/pipeline/#/experiments/details/23d4aee2-ce95-4869-8a7e-5e309180afc4" target="_blank" >Experiment details</a>.</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<a href="http://kubeflow.geoanalytics.ca/pipeline/#/runs/details/21f8d435-b8ae-46ae-a4a3-eda8af64251d" target="_blank" >Run details</a>.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>echo_pipeline = kubeflow_client.client.upload_pipeline(pipeline_filename, pipeline_name, &quot;DAILY AVERAGE NDSI PIPELINE&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<a href=http://kubeflow.geoanalytics.ca/pipeline/#/pipelines/details/0d40765c-4a91-4ba0-af2e-1fde412d00c0>Pipeline details</a>.</div>
</div>
</section>
<section id="4.-The-Results">
<h2>4. The Results<a class="headerlink" href="#4.-The-Results" title="Permalink to this headline">#</a></h2>
<p>Head over to the Kubeflow Pipeline UI and take a look at the Run you created. Once finished, the pipeline graph should look like this image below.</p>
<p><img alt="f4a2526c838348118c6609676995e62c" src="../_images/01_pipeline-graph.png" /></p>
<p>To see the final plot of the Averaged NDSI over the past few days, click on the <code class="docutils literal notranslate"><span class="pre">plot_ndsi</span></code> operation and under the <strong>“Input/Output”</strong>, click on the link in the Output Artifacts section. This is open a new tab with the final plot shown, which should look similar to this:</p>
<p><img alt="ee018f79fc5a4298b66504a0bf7a4824" src="../_images/01_pipeline-result.png" /></p>
<p><strong>Note: This NDSI was processed on September 2nd, 2021.</strong></p>
</section>
<section id="5.-Additional-Sources">
<h2>5. Additional Sources<a class="headerlink" href="#5.-Additional-Sources" title="Permalink to this headline">#</a></h2>
<p>For additional information take a look at these resources:</p>
<ul class="simple">
<li><p>Information about the MOD10A Product: <a class="reference external" href="https://nsidc.org/data/MOD10A1/versions/6">https://nsidc.org/data/MOD10A1/versions/6</a></p></li>
<li><p>Building Python Function-based Components: <a class="reference external" href="https://www.kubeflow.org/docs/components/pipelines/sdk/v2/python-function-components/">https://www.kubeflow.org/docs/components/pipelines/sdk/v2/python-function-components/</a></p></li>
<li><p>The GCSFS Documentation: <a class="reference external" href="https://fs-gcsfs.readthedocs.io/en/latest/">https://fs-gcsfs.readthedocs.io/en/latest/</a></p></li>
<li><p>Information about Kubeflow Pipelines Output Artifacts: <a class="reference external" href="https://www.kubeflow.org/docs/components/pipelines/sdk/output-viewer/">https://www.kubeflow.org/docs/components/pipelines/sdk/output-viewer/</a></p></li>
<li><p>The Kubeflow Pipeline SDK API Documentation: <a class="reference external" href="https://kubeflow-pipelines.readthedocs.io/en/latest/index.html">https://kubeflow-pipelines.readthedocs.io/en/latest/index.html</a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          <a class="prev-page" href="index.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Scientific Workflows</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Hatfield Consultants
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#"><strong>Daily NDSI Average Pipeline</strong></a><ul>
<li><a class="reference internal" href="#1.-Connect-to-Kubeflow-Client">1. Connect to Kubeflow Client</a></li>
<li><a class="reference internal" href="#2.-Implementing-the-Python-Functions">2. Implementing the Python Functions</a><ul>
<li><a class="reference internal" href="#2.1-Querying-Data-Function">2.1 Querying Data Function</a></li>
<li><a class="reference internal" href="#2.2-Thresholding-and-Creating-Mosaic-Function">2.2 Thresholding and Creating Mosaic Function</a></li>
<li><a class="reference internal" href="#2.3-Computing-Average-NDSI-Function">2.3 Computing Average NDSI Function</a></li>
<li><a class="reference internal" href="#2.4-Plotting-the-Final-NDSI-Function">2.4 Plotting the Final NDSI Function</a></li>
<li><a class="reference internal" href="#2.5-Delete-Files-Function">2.5 Delete Files Function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#3.-Assembling-the-Pipeline">3. Assembling the Pipeline</a></li>
<li><a class="reference internal" href="#4.-The-Results">4. The Results</a></li>
<li><a class="reference internal" href="#5.-Additional-Sources">5. Additional Sources</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>