<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="K-Means Land Classification with Dask" href="02-kmeans-dask.html" /><link rel="prev" title="Scientific Workflows" href="index.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2022.04.07"/>
        <title>Daily NDSI Average Pipeline - GeoAnalytics Canada</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=68f4518137b9aefe99b631505a2064c3c42c9852" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">GeoAnalytics Canada</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/geoanalytics-icon.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">GeoAnalytics Canada</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../1_getting_started/index.html">Getting Started</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/00-how-to-use-this-documentation.html">How to use this documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/02-geospatial-python.html"><strong>Working with Earth Observation data in Python</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/04-authentication.html"><strong>Authentication</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/03-jupyter-notebooks.html"><strong>Jupyter Notebooks</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/05-desktop-vm.html"><strong>Desktop VM’s</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/05a-ssh-keys.html">Set Up SSH Keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/05b-remote-connect-vscode.html">Remote Connection via VSCode</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/06-file-browser.html"><strong>File Browser</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/07-stac.html"><strong>SpatioTemporal Asset Catalog (STAC)</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/08-container-registry.html"><strong>Container Registry</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/09-pipelines.html"><strong>Pipelines</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../1_getting_started/10-dask.html"><strong>Dask</strong></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../2_real_world_examples/index.html">Real World Examples</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/01-accessing-data.html"><strong>Accessing and Downloading Data</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/02-ndvi-s2-dask.html"><strong>NDVI with Sentinel-2 and Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/03-ndsi-modis-dask.html"><strong>NDSI with MODIS and Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/04-ndmi-landsat8-dask.html"><strong>NDMI with Landsat 8 Dask</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_real_world_examples/05-change-detection.html"><strong>Change Detection</strong></a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Scientific Workflows</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#"><strong>Daily NDSI Average Pipeline</strong></a></li>
<li class="toctree-l2"><a class="reference internal" href="02-kmeans-dask.html">K-Means Land Classification with Dask</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-composite.html">Compositing Rasters with Dask</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-add-to-stac.html"><strong>Adding data to the Geoanalytics STAC server</strong></a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container"><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Daily-NDSI-Average-Pipeline">
<h1><strong>Daily NDSI Average Pipeline</strong><a class="headerlink" href="#Daily-NDSI-Average-Pipeline" title="Permalink to this headline">#</a></h1>
<p>In this tutorial notebook, we will build a Kubeflow Pipeline which will process the Modis Snow Product over the previous 5 to 8 days (depending on user input) and return the visualization of the NDSI Average in British Columbia, Canada.</p>
<p>The main steps for creating the Daily NDSI Average Pipeline:</p>
<ol class="arabic simple">
<li><p>Query MODIS snow product (MOD10A1.001) data using a bounding box AOI and date ranges</p></li>
<li><p>Threshold the NDSI</p></li>
<li><p>Create mosaics from raw MODIS granules by merging different tiles together</p></li>
<li><p>Compute the NDSI average over the date range</p></li>
<li><p>Visualize the NDSI averages</p></li>
</ol>
<p>All these steps for this tutorial will be separated into pipeline components, based on Python functions we will implement.</p>
<p><strong>First, run the following command to install all the packages and dependencies required for this tutorial</strong>. The requirements.txt file contains the Python CMR API for data querying, and the Kubeflow Pipelines SDK and lxml (a Python library which allows for easy handling of XML and HTML files, and can also be used for web scraping).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span> pip install -r data/requirements_6.txt
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">import</span> <span class="nn">kfp</span>

<span class="kn">import</span> <span class="nn">kfp.dsl</span> <span class="k">as</span> <span class="nn">dsl</span>
<span class="kn">import</span> <span class="nn">kfp.gcp</span> <span class="k">as</span> <span class="nn">gcp</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">html</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">storage</span>
<span class="kn">from</span> <span class="nn">kubernetes</span> <span class="kn">import</span> <span class="n">client</span>
<span class="kn">from</span> <span class="nn">kubernetes.client</span> <span class="kn">import</span> <span class="n">V1Toleration</span>
<span class="kn">from</span> <span class="nn">kfp.components</span> <span class="kn">import</span> <span class="n">InputPath</span><span class="p">,</span> <span class="n">OutputPath</span><span class="p">,</span> <span class="n">create_component_from_func</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">build_opener</span><span class="p">,</span> <span class="n">HTTPCookieProcessor</span>
</pre></div>
</div>
</div>
<section id="1.-Connect-to-Kubeflow-Client">
<h2>1. Connect to Kubeflow Client<a class="headerlink" href="#1.-Connect-to-Kubeflow-Client" title="Permalink to this headline">#</a></h2>
<p>To create a pipeline, we must first connect to GEOAnalytics’ Kubeflow Pipeline Client. Please run the cell below and enter your GEOAnalytics username and password to authenticate the client.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">### GEOAnalyticsKubeflowClient</span>

<span class="k">class</span> <span class="nc">GEOAnalyticsKubeflowClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">auth_provider</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_logger</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">username</span> <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">namespace</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_authenticate</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">auth_provider</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_client_connection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_initialize_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> (</span><span class="si">%(name)s</span><span class="s1">): </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">'%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"GEOAnalyticsKubeflowClient"</span><span class="p">)</span>

    <span class="c1"># https://github.com/kubeflow/kfctl/issues/140#issuecomment-719894529</span>
    <span class="k">def</span> <span class="nf">_authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">auth_provider</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">auth_provider</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"application/x-www-form-urlencoded"</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">auth_provider</span><span class="o">.</span><span class="n">get_auth_data_dict</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">post_url</span> <span class="o">=</span> <span class="n">auth_provider</span><span class="o">.</span><span class="n">get_auth_post_url</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">post_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">session_cookie</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get_dict</span><span class="p">()[</span><span class="s2">"authservice_session"</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">"invalid host or credentials"</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">kfp</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">auth_provider</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">/pipeline"</span><span class="p">,</span>
            <span class="n">cookies</span><span class="o">=</span><span class="sa">f</span><span class="s2">"authservice_session=</span><span class="si">{</span><span class="n">session_cookie</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
        <span class="p">)</span>


    <span class="k">def</span> <span class="nf">_validate_client_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">list_pipelines</span><span class="p">()</span><span class="o">.</span><span class="n">total_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"successfully authenticated with kubeflow"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">"unable to validate kubeflow client connection. listing pipelines failed."</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DexProvider</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"dex"</span>

    <span class="k">def</span> <span class="nf">get_auth_data_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"login"</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s2">"password"</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_auth_post_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_response</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">initial_response</span><span class="o">.</span><span class="n">url</span>

    <span class="k">def</span> <span class="nf">get_provider_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">provider</span> <span class="o">=</span> <span class="n">DexProvider</span><span class="p">(</span><span class="s2">"http://kubeflow.geoanalytics.ca"</span><span class="p">)</span>
<span class="n">kubeflow_client</span> <span class="o">=</span> <span class="n">GEOAnalyticsKubeflowClient</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">"Username: "</span><span class="p">),</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(),</span> <span class="n">provider</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Username:  asaini
 ············
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2021-09-08 19:35:27 INFO (GEOAnalyticsKubeflowClient): successfully authenticated with kubeflow
</pre></div></div>
</div>
<p>Now, before we can move forward to building our functions, make sure you have an <strong>existing NASA EarthData account</strong>. We require authentication for retrieving the MODIS data in this example. If you do not have an EarthData account yet, you can create it for free here: <a class="reference external" href="https://urs.earthdata.nasa.gov/home">https://urs.earthdata.nasa.gov/home</a></p>
<p>Then, enter in your <strong>username</strong> and <strong>password</strong> in the cell input below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 asaini
 ·············
</pre></div></div>
</div>
</section>
<section id="2.-Implementing-the-Python-Functions">
<h2>2. Implementing the Python Functions<a class="headerlink" href="#2.-Implementing-the-Python-Functions" title="Permalink to this headline">#</a></h2>
<p>Once we have our authentications ready, let’s move on and create the functions. The python functions will implement the steps for the working pipeline, which will be converted to components using the <code class="docutils literal notranslate"><span class="pre">kfp.components.create_component_from_func(&lt;python</span> <span class="pre">function&gt;,</span> <span class="pre">&lt;base</span> <span class="pre">image&gt;)</span></code>. The custom Docker image, stored at <em>‘registry.geoanalytics.ca/examples/modis-ndsi’</em>, is already created with all the necessary packages and files installed, ready for you to use.</p>
<section id="2.1-Querying-Data-Function">
<h3>2.1 Querying Data Function<a class="headerlink" href="#2.1-Querying-Data-Function" title="Permalink to this headline">#</a></h3>
<p>The first step of the process to to collect information about the data we want. Given the number of most recent days and an area of interest, the function must output a list of granules URLs.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Creates a EarthData client passing in the username and password collected in above, using Hatfield CMR.</p></li>
<li><p>Opens the polygon shapefile (saved in our Docker image) and uses its bounds as the area of interest.</p></li>
<li><p>Creates a date range based on the days provided.</p></li>
<li><p>Queries for granules matching the provided requirements.</p></li>
<li><p>Separate URLs of granules into sublists according to their dates.</p></li>
<li><p>Return the list of lists.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">query_modis_data</span><span class="p">(</span><span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">polygon</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">earthdata_user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">earthdata_pass</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
    <span class="kn">from</span> <span class="nn">hatfieldcmr</span> <span class="kn">import</span> <span class="n">CMRClient</span>

    <span class="c1"># Create earthdata client</span>
    <span class="n">ed_client</span> <span class="o">=</span> <span class="n">CMRClient</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">earthdata_user</span><span class="p">,</span> <span class="n">earthdata_pass</span><span class="p">)</span>

     <span class="c1"># Query for granule metadata from NASA CMR</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">polygon</span> <span class="o">+</span> <span class="s1">'/*.shp'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bounding_box</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># End date is 4 days ago from current date to allow enough time for correctly processed data</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="s1">'MOD10A1.6'</span>

    <span class="n">granules</span> <span class="o">=</span> <span class="n">ed_client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">),</span> <span class="n">product</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bounding_box</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">granules</span><span class="p">)</span><span class="si">}</span><span class="s2"> granules from query"</span><span class="p">)</span>

    <span class="c1"># Separate urls of granules into sublists according to dates</span>
    <span class="n">urls_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sublist</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">get_date</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'\d</span><span class="si">{4}</span><span class="s1">\d</span><span class="si">{3}</span><span class="s1">'</span><span class="p">,</span> <span class="n">granules</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'links'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'href'</span><span class="p">])</span>
    <span class="n">prev_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">get_date</span><span class="o">.</span><span class="n">group</span><span class="p">(),</span> <span class="s1">'%Y%j'</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">granules</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">'links'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'href'</span><span class="p">]</span>
        <span class="n">get_date</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'\d</span><span class="si">{4}</span><span class="s1">\d</span><span class="si">{3}</span><span class="s1">'</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">new_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">get_date</span><span class="o">.</span><span class="n">group</span><span class="p">(),</span> <span class="s1">'%Y%j'</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="c1"># Condition to separate to a different sublist: if date is different or its the last granule in the list</span>
        <span class="k">if</span> <span class="n">new_date</span> <span class="o">!=</span> <span class="n">prev_date</span> <span class="ow">or</span> <span class="n">file</span> <span class="o">==</span> <span class="n">granules</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">sublist_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">sublist</span><span class="p">)</span>
            <span class="n">urls_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sublist_json</span><span class="p">)</span>
            <span class="n">prev_date</span> <span class="o">=</span> <span class="n">new_date</span>
            <span class="n">sublist</span> <span class="o">=</span><span class="p">[]</span>
            <span class="k">continue</span>

        <span class="n">sublist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Serializing json</span>
    <span class="n">urls_list_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">urls_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urls_list_json</span>


<span class="n">query_modis_data_op</span> <span class="o">=</span> <span class="n">create_component_from_func</span><span class="p">(</span><span class="n">query_modis_data</span><span class="p">,</span><span class="n">base_image</span><span class="o">=</span><span class="s1">'registry.geoanalytics.ca/examples/modis-ndsi'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="2.2-Thresholding-and-Creating-Mosaic-Function">
<h3>2.2 Thresholding and Creating Mosaic Function<a class="headerlink" href="#2.2-Thresholding-and-Creating-Mosaic-Function" title="Permalink to this headline">#</a></h3>
<p>The function <code class="docutils literal notranslate"><span class="pre">create_mosaics()</span></code> combines the two steps of thresholding the NDSI of each granule, and combining same date granules together.</p>
<p>The inputs of this function are the sublist of urls of the same date, EarthData credentials, the polygon of British Columbia, and the path to our GEOAnalytics bucket where our generated mosaics will stored.</p>
<p>We will be using the MOD10A Version 6 Product which included the computed NDSI Snow Cover values. The NDSI formula is the normalized difference between highly Visible (VIR) and Shortwave Infrared (SWIR) bands. We will need to threshold to make sure to separate the snow-covered pixels from no-snow pixels. Pixels with values between 20 and 100 are considered <strong>Snow Pixels</strong>.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the Google Cloud Storage File System (GCSFS) API’s credentials for accessing our buckets.</p>
<ul>
<li><p>Token is the secret key JSON file which is loaded into the Docker container.</p></li>
</ul>
</li>
<li><p>Create an EarthData Client.</p></li>
<li><p>Iterates through each URL in the list of URLS (of the same date)</p>
<ul>
<li><p>Using the Hatfield CMR, stream in the granule into a temporary file.</p></li>
<li><p>Threshold the NDSI (Snow pixels set to 1, otherwise 0).</p></li>
<li><p>Append the updated DataArray to a list.</p></li>
</ul>
</li>
<li><p>Merge the list of DataArrays together.</p></li>
<li><p>Reproject the merged array to the same Coordinate Reference System (CRS) as the BC Polygon.</p></li>
<li><p>Clip the mosaic to the polygon.</p></li>
<li><p>Write the mosaic raster to a local file.</p></li>
<li><p>Copy the contents from the local file to a folder for the current date on Google Cloud.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">create_mosaics</span><span class="p">(</span><span class="n">urls</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">earthdata_user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">earthdata_pass</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">polygon</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gcs_paths</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OutputPath</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>
    <span class="kn">import</span> <span class="nn">rasterio</span>
    <span class="kn">import</span> <span class="nn">gcsfs</span>
    <span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rxr</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">from</span> <span class="nn">hatfieldcmr</span> <span class="kn">import</span> <span class="n">CMRClient</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">build_opener</span><span class="p">,</span> <span class="n">HTTPCookieProcessor</span>
    <span class="kn">from</span> <span class="nn">rioxarray.merge</span> <span class="kn">import</span> <span class="n">merge_arrays</span>

    <span class="c1"># Set up the gcsfs system with credentials</span>
    <span class="n">tok</span> <span class="o">=</span> <span class="s1">'/secret/gcp-credentials/geoanalytics-canada-kubeflow.json'</span>
    <span class="n">tok_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
    <span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">tok_dict</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">'read_write'</span><span class="p">)</span>

    <span class="c1"># Create earthdata client</span>
    <span class="n">ed_client</span> <span class="o">=</span> <span class="n">CMRClient</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">earthdata_user</span><span class="p">,</span> <span class="n">earthdata_pass</span><span class="p">)</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">downloads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="c1"># Get date for file naming</span>
        <span class="n">get_date</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">'\d</span><span class="si">{4}</span><span class="s1">\d</span><span class="si">{3}</span><span class="s1">'</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">get_date</span><span class="o">.</span><span class="n">group</span><span class="p">(),</span> <span class="s1">'%Y%j'</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>

        <span class="c1"># Stream in the current granule</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="n">ed_client</span><span class="o">.</span><span class="n">download_earthdata_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">(</span><span class="n">earthdata_user</span><span class="p">,</span> <span class="n">earthdata_pass</span><span class="p">))</span> <span class="c1"># download the image into memory</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpfile</span><span class="p">:</span>
            <span class="n">tmpfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buff</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="k">with</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">ndsi</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">NDSI_Snow_Cover</span>
                <span class="c1"># Threshold NDSI</span>
                <span class="n">ndsi</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="n">ndsi</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ndsi</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="n">ndsi</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ndsi</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="n">ndsi</span><span class="o">.</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">ndsi</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="n">downloads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndsi</span><span class="p">)</span>

    <span class="c1">#Merge granules together into a mosaic</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">merge_arrays</span><span class="p">(</span><span class="n">downloads</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Dataset size (Gb): '</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span>

    <span class="c1"># Reproject and crop to the polygon</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">polygon</span> <span class="o">+</span> <span class="s1">'/*.shp'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bounding_box</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip_box</span><span class="p">(</span><span class="o">*</span><span class="n">bounding_box</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Dataset size (Gb): '</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">nbytes</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span>

    <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">.tif'</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">recalc_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Saving to GCP</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">gcs_paths</span><span class="si">}{</span><span class="n">today</span><span class="si">}</span><span class="s1">/mosaics/</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">.tif'</span>
    <span class="n">gcs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span>

<span class="n">create_mosaics_op</span> <span class="o">=</span> <span class="n">create_component_from_func</span><span class="p">(</span><span class="n">create_mosaics</span><span class="p">,</span> <span class="n">base_image</span><span class="o">=</span><span class="s1">'registry.geoanalytics.ca/examples/modis-ndsi'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="2.3-Computing-Average-NDSI-Function">
<h3>2.3 Computing Average NDSI Function<a class="headerlink" href="#2.3-Computing-Average-NDSI-Function" title="Permalink to this headline">#</a></h3>
<p>Once the mosaics for all the dates are created, the next step will require a function which stacks these mosaics and calculates the average NDSI value of the mosaics. The GCS path will be passed in as input, pointing to where all the mosaics are stored.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the GCSFS credentials for accessing the bucket (same as in previous function)</p></li>
<li><p>Iteratively search for and save the dimensions and shape of the mosaic with the smallest size.</p>
<ul>
<li><p>All mosaic arrays must be same size to be stacked together.</p></li>
</ul>
</li>
<li><p>Resize all mosaics to the saved shape.</p></li>
<li><p>Make sure the number of mosaics equals to the number of days that are requested.</p></li>
<li><p>Stack the mosaics together.</p></li>
<li><p>Compute the mean over all the mosaics.</p></li>
<li><p>Place the averaged mosaics in a DataArray with the saved dimensions.</p></li>
<li><p>Write the mosaic raster to a local file.</p></li>
<li><p>Copy the contents from the local file into the same location where the mosaics are stored.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">average_ndsi</span><span class="p">(</span><span class="n">gcs_paths</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="kn">import</span> <span class="nn">gcsfs</span>
    <span class="kn">import</span> <span class="nn">rasterio</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rxr</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

     <span class="c1"># Set up the gcsfs system with credentials</span>
    <span class="n">tok</span> <span class="o">=</span> <span class="s1">'/secret/gcp-credentials/geoanalytics-canada-kubeflow.json'</span>
    <span class="n">tok_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
    <span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">tok_dict</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">'read_write'</span><span class="p">)</span>

    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="n">mosaics</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">gcs_paths</span><span class="si">}{</span><span class="n">today</span><span class="si">}</span><span class="s1">/mosaics/'</span><span class="p">)</span>

    <span class="c1"># Arbitrary variables to be replaced</span>
    <span class="n">_dims_x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_dims_y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100000</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>

    <span class="c1"># Get the shape of the smallest mosaic for stacking</span>
    <span class="k">for</span> <span class="n">mosaic</span> <span class="ow">in</span> <span class="n">mosaics</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">mosaic</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.tif'</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">with</span> <span class="n">gcs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mosaic</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">ndsi</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">shape</span> <span class="o">&lt;</span> <span class="n">_shape</span><span class="p">:</span>
                    <span class="n">_shape</span> <span class="o">=</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">_dims_x</span> <span class="o">=</span> <span class="n">ndsi</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span>
                    <span class="n">_dims_y</span> <span class="o">=</span> <span class="n">ndsi</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span>

    <span class="c1"># Resize all the mosaics to the size of the smallest one</span>
    <span class="n">arrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mosaic</span> <span class="ow">in</span> <span class="n">mosaics</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">mosaic</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.tif'</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="k">with</span> <span class="n">gcs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mosaic</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">ndsi</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                <span class="n">ndsi</span><span class="o">.</span><span class="n">data</span><span class="p">[(</span><span class="n">ndsi</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">arrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndsi</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="n">_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">:</span><span class="n">_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="c1"># Assert that the number of mosaics matches the days requested</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrs</span><span class="p">)</span> <span class="o">==</span> <span class="n">days</span><span class="p">)</span>

    <span class="n">stk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">arrs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># stacking</span>
    <span class="n">stk</span> <span class="o">=</span> <span class="n">stk</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>           <span class="c1"># squeezing</span>
    <span class="n">stk_mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stk</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># averaging</span>

    <span class="c1"># Combining and returning the DataArray</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">stk_mn</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">(</span><span class="n">_dims_y</span><span class="p">,</span><span class="n">_dims_x</span><span class="p">))</span>

    <span class="n">file</span> <span class="o">=</span> <span class="s1">'average_ndsi.tif'</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">to_raster</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">recalc_transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Saving to GCP</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">gcs_paths</span><span class="si">}{</span><span class="n">today</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">'</span>
    <span class="n">gcs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_path</span>

<span class="n">average_ndsi_op</span> <span class="o">=</span> <span class="n">create_component_from_func</span><span class="p">(</span><span class="n">average_ndsi</span><span class="p">,</span> <span class="n">base_image</span><span class="o">=</span><span class="s1">'registry.geoanalytics.ca/examples/modis-ndsi'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="2.4-Plotting-the-Final-NDSI-Function">
<h3>2.4 Plotting the Final NDSI Function<a class="headerlink" href="#2.4-Plotting-the-Final-NDSI-Function" title="Permalink to this headline">#</a></h3>
<p>Once the mosaics for all the dates are created, the next step will require a function which stacks these mosaics and calculates the average NDSI value of the mosaics. The GCS path will be passed in as input, pointing to where all the mosaics are stored.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the GCSFS credentials for accessing the bucket.</p></li>
<li><p>Load in the average NDSI tiff stored in GCS.</p></li>
<li><p>Crop to the BC Polygon shape.</p></li>
<li><p>Plot the image with the boundary of BC outlining the edges.</p></li>
<li><p>Save the figure as a temporary binary file.</p></li>
<li><p>Encode to base64 so it can be shown as in image source in HTML as a “Pipeline Output Artifact.”</p></li>
<li><p>Write the metadata for the output viewer and save as a metadata file.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot_ndsi</span><span class="p">(</span><span class="n">final_ndsi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">polygon</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">mlpipeline_ui_metadata_path</span><span class="p">:</span> <span class="n">OutputPath</span><span class="p">()):</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="kn">import</span> <span class="nn">gcsfs</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">rasterio</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="kn">import</span> <span class="nn">rioxarray</span> <span class="k">as</span> <span class="nn">rxr</span>
    <span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
    <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">mapping</span>

     <span class="c1"># Set up the gcsfs system with credentials</span>
    <span class="n">tok</span> <span class="o">=</span> <span class="s1">'/secret/gcp-credentials/geoanalytics-canada-kubeflow.json'</span>
    <span class="n">tok_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
    <span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">tok_dict</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">'read_write'</span><span class="p">)</span>

    <span class="c1"># Load in the tiff file from GCS as a DataArray and crop to BC</span>
    <span class="k">with</span> <span class="n">gcs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">final_ndsi</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span> <span class="k">as</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">ndsi</span> <span class="o">=</span> <span class="n">rxr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
                <span class="n">bc</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">polygon</span> <span class="o">+</span> <span class="s1">'/*.shp'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ndsi</span> <span class="o">=</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">write_crs</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                <span class="n">ndsi</span> <span class="o">=</span> <span class="n">ndsi</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">mapping</span><span class="p">),</span> <span class="n">bc</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

    <span class="c1"># Plot the image</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">ndsi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdYlBu</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bc</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span><span class="c1">#, facecolor="None")</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">"NDSI average over </span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s2"> days"</span><span class="p">)</span>

    <span class="c1"># Save image as a binary temp file to be encoded to base64</span>
    <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'png'</span><span class="p">)</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>

    <span class="n">html</span> <span class="o">=</span> <span class="s1">'&lt;img src=</span><span class="se">\'</span><span class="s1">data:image/png;base64,</span><span class="si">{}</span><span class="se">\'</span><span class="s1">&gt;'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'outputs'</span> <span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s1">'source'</span><span class="p">:</span> <span class="n">html</span><span class="p">,</span>
      <span class="s1">'storage'</span><span class="p">:</span> <span class="s1">'in-line'</span><span class="p">,</span>
      <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'markdown'</span><span class="p">,</span>
    <span class="p">}]}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mlpipeline_ui_metadata_path</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">metadata_file</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">metadata_file</span><span class="p">)</span>

<span class="n">plot_ndsi_op</span> <span class="o">=</span> <span class="n">create_component_from_func</span><span class="p">(</span><span class="n">plot_ndsi</span><span class="p">,</span> <span class="n">base_image</span><span class="o">=</span><span class="s1">'registry.geoanalytics.ca/examples/modis-ndsi'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Pipeline Output Artifact:</strong> The Kubeflow Pipelines UI provides built-in support for many types of visualizations. The current available <em>Output Viewers</em> are Confusion matrix, Markdown, ROC curve, Table, TensorBoard, and Web app. For our example, we want to output a final Raster image using matplotlib, so the output viewers we can use are Markdown or <strong>Web app.</strong> These will allow us to pass in static HTML code that can be displayed in the Output Artifacts.</p>
</section>
<section id="2.5-Delete-Files-Function">
<h3>2.5 Delete Files Function<a class="headerlink" href="#2.5-Delete-Files-Function" title="Permalink to this headline">#</a></h3>
<p>Since our pipeline stores the files we’ve created for today and this is a Daily NDSI Average Pipeline, it is unnecessary to keep the data once we have the final result. The function <code class="docutils literal notranslate"><span class="pre">delete_files()</span></code> will permanently remove the folder for today’s date containing all the data stored in the GEOAnalytic’s Google Cloud bucket.</p>
<p>The function:</p>
<ul class="simple">
<li><p>Sets up the GCSFS credentials for accessing the bucket.</p></li>
<li><p>Access the folder for today’s date within the GCS bucket.</p></li>
<li><p>Check if files exist within this folder.</p></li>
<li><p>Check if the folder contains subfolders.</p>
<ul>
<li><p>Delete files from the subfolder.</p></li>
</ul>
</li>
<li><p>Delete all files from the folder (This will implicitly delete the empty folder itself).</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">delete_files</span><span class="p">(</span><span class="n">gcs_paths</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mlpipeline_ui_metadata_path</span><span class="p">:</span> <span class="n">OutputPath</span><span class="p">()):</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="kn">import</span> <span class="nn">gcsfs</span>
    <span class="kn">import</span> <span class="nn">glob</span>
    <span class="kn">import</span> <span class="nn">datetime</span>

     <span class="c1"># Set up the gcsfs system with credentials</span>
    <span class="n">tok</span> <span class="o">=</span> <span class="s1">'/secret/gcp-credentials/geoanalytics-canada-kubeflow.json'</span>
    <span class="n">tok_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">tok</span><span class="p">))</span>
    <span class="n">gcs</span> <span class="o">=</span> <span class="n">gcsfs</span><span class="o">.</span><span class="n">GCSFileSystem</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">tok_dict</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="s1">'read_write'</span><span class="p">)</span>

    <span class="c1"># Access the directory with files created for today's run</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

    <span class="n">main_folder</span> <span class="o">=</span> <span class="n">gcs_paths</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">today</span><span class="p">)</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">main_folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">main_folder</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">:</span>
            <span class="n">subfolder</span> <span class="o">=</span> <span class="n">gcs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subfolder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># If the object is a subfolder</span>
                <span class="n">empty_subfile</span> <span class="o">=</span> <span class="p">[</span><span class="n">gcs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">subfolder</span><span class="p">]</span> <span class="c1"># Delete all files in subfolder</span>
            <span class="n">gcs</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># Delete other files in the main folder</span>

<span class="n">delete_files_op</span> <span class="o">=</span> <span class="n">create_component_from_func</span><span class="p">(</span><span class="n">delete_files</span><span class="p">,</span> <span class="n">base_image</span><span class="o">=</span><span class="s1">'registry.geoanalytics.ca/examples/modis-ndsi'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="3.-Assembling-the-Pipeline">
<h2>3. Assembling the Pipeline<a class="headerlink" href="#3.-Assembling-the-Pipeline" title="Permalink to this headline">#</a></h2>
<p>Once we have our components ready, the next step is to put them together in a pipeline. The Daily NDSI Pipeline will take the arguments for the number of days you want an average over, your EarthData username and password, the path to the polygon shapefile (this file is already downloaded in the base image), and the GCS path where files will be stored.</p>
<p>Now there are two important variables to notice:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">custom_nodepool</span></code> which is an operator that configures the Google Kubernetes Engine (GKE) preemptible in a container op, custom to this tutorial.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gcp_key</span></code>, an operator to configure the container to use Google Cloud Platform (GCP) service account by service account key stored in a Kubernetes secret. This allows us to read and write to GEOAnalytics GCS buckets.</p></li>
</ul>
<p>Applying these operators to the components will allow the pipeline to run smoothly. We will also set the CPI request at 3.5 and memory request at 11,000 MB to enforce operations running on individual pods.</p>
<ol class="arabic simple">
<li><p>The first component to be called in the converted <code class="docutils literal notranslate"><span class="pre">query_modis_data</span></code> function.</p></li>
<li><p>The next step is to threshold the NDSI and combine the rasters for the same date in a mosaic using <code class="docutils literal notranslate"><span class="pre">create_mosaic</span></code>. To efficiently do this, we will use the <code class="docutils literal notranslate"><span class="pre">dsl.ParallelFor</span></code> loop which will run the process operation on different pods, where each pod will take sublist of the list of granule URLs as input. i.e. Each pod will process granules of a different date, so the number of pods should be equivalent to the number of days passed in.</p></li>
<li><p>After we have the mosaics created, we will compute the average of the NDSI with our <code class="docutils literal notranslate"><span class="pre">average_ndsi_op</span></code> operation. the <code class="docutils literal notranslate"><span class="pre">.after(processOp)</span></code> method constrains the operation to start once the previous parallel operations are complete.</p></li>
<li><p>Finally, passing in the output path from the previous operation to the averaged GeoTIFF, we can plot the final image.</p></li>
<li><p>An optional step is to delete the files created and stored within the GCS. If you want to take a look at the saved files, the mosaics and the final average NDSI (all GeoTIFFs), then simply comment out the <code class="docutils literal notranslate"><span class="pre">deleteOp</span></code>.</p></li>
</ol>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@dsl</span><span class="o">.</span><span class="n">pipeline</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">'MOD10A1 Daily NDSI Average Processing Pipeline'</span><span class="p">,</span>
  <span class="n">description</span><span class="o">=</span><span class="s1">'A pipeline that processes the daily Normalized Difference Snow Index in British Columbia given a time range.'</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">daily_ndsi_pipeline</span><span class="p">(</span><span class="n">days</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">earthdata_user</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">earthdata_pass</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">polygon</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gcs_paths</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

    <span class="n">custom_nodepool</span> <span class="o">=</span> <span class="n">gcp</span><span class="o">.</span><span class="n">use_preemptible_nodepool</span><span class="p">(</span><span class="n">V1Toleration</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">'daily-ndsi-processing'</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">'Exists'</span><span class="p">))</span>
    <span class="n">gcp_key</span> <span class="o">=</span> <span class="n">gcp</span><span class="o">.</span><span class="n">use_gcp_secret</span><span class="p">(</span><span class="n">secret_name</span><span class="o">=</span><span class="s1">'user-gcp-sa'</span><span class="p">,</span> <span class="n">secret_file_path_in_volume</span><span class="o">=</span><span class="s1">'/geoanalytics-canada-kubeflow.json'</span><span class="p">)</span>

    <span class="c1"># 1. Fetch the URLs of our MODIS data from the query</span>
    <span class="n">fetchOp</span> <span class="o">=</span> <span class="n">query_modis_data_op</span><span class="p">(</span><span class="n">days</span><span class="p">,</span>
                                  <span class="n">polygon</span><span class="p">,</span>
                                  <span class="n">earthdata_user</span><span class="p">,</span>
                                  <span class="n">earthdata_pass</span>
                                 <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_nodepool</span><span class="p">)</span><span class="c1">#.set_cpu_request('3.5').set_memory_request('11000M')</span>

    <span class="c1"># 2. "Download" the data and create mosaics stored in a list</span>
    <span class="k">with</span> <span class="n">dsl</span><span class="o">.</span><span class="n">ParallelFor</span><span class="p">(</span><span class="n">fetchOp</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="k">as</span> <span class="n">item</span><span class="p">:</span>
        <span class="n">processOp</span> <span class="o">=</span> <span class="n">create_mosaics_op</span><span class="p">(</span><span class="n">item</span><span class="p">,</span>
                                      <span class="n">earthdata_user</span><span class="p">,</span>
                                      <span class="n">earthdata_pass</span><span class="p">,</span>
                                      <span class="n">polygon</span><span class="p">,</span>
                                      <span class="n">gcs_paths</span>
                                     <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_nodepool</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gcp_key</span><span class="p">)</span><span class="o">.</span><span class="n">set_cpu_request</span><span class="p">(</span><span class="s1">'3.5'</span><span class="p">)</span><span class="o">.</span><span class="n">set_memory_request</span><span class="p">(</span><span class="s1">'11000M'</span><span class="p">)</span><span class="o">.</span><span class="n">set_retry</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># 3. Get average of the all the mosaics</span>
    <span class="n">combineOp</span> <span class="o">=</span> <span class="n">average_ndsi_op</span><span class="p">(</span><span class="n">gcs_paths</span><span class="p">,</span>
                               <span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">processOp</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_nodepool</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gcp_key</span><span class="p">)</span><span class="c1">#.set_cpu_request('3.5').set_memory_request('11000M').set_retry(3)</span>

    <span class="c1"># 4. Plot the average (input is an Xarray DataArray)</span>
    <span class="n">plottingOp</span> <span class="o">=</span> <span class="n">plot_ndsi_op</span><span class="p">(</span><span class="n">combineOp</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                              <span class="n">polygon</span><span class="p">,</span>
                              <span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_nodepool</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gcp_key</span><span class="p">)</span><span class="c1">#.set_cpu_request('3.5').set_memory_request('11000M').set_retry(3)</span>

     <span class="c1"># 5. Delete files from GCS</span>
    <span class="n">deleteOp</span> <span class="o">=</span> <span class="n">delete_files_op</span><span class="p">(</span><span class="n">gcs_paths</span><span class="p">)</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="n">plottingOp</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_nodepool</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gcp_key</span><span class="p">)</span><span class="c1">#.set_cpu_request('3.5').set_memory_request('11000M').set_retry(3)</span>

    <span class="c1"># Configurations for the pipeline to run in the specific nodepool and allowing access to GEOAnalytics' container Rrgistry</span>
    <span class="n">dsl</span><span class="o">.</span><span class="n">get_pipeline_conf</span><span class="p">()</span><span class="o">.</span><span class="n">set_default_pod_node_selector</span><span class="p">(</span><span class="s1">'app.geoanalytics.ca/nodepool'</span><span class="p">,</span> <span class="s1">'daily-ndsi-processing'</span><span class="p">)</span>
    <span class="n">dsl</span><span class="o">.</span><span class="n">get_pipeline_conf</span><span class="p">()</span><span class="o">.</span><span class="n">set_image_pull_secrets</span><span class="p">([</span><span class="n">client</span><span class="o">.</span><span class="n">V1LocalObjectReference</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"regcredgeoanalytics"</span><span class="p">)])</span>

</pre></div>
</div>
</div>
<p>Let’s compile the pipeline with the name <strong>“Average NDSI Pipeline!”</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># COMPILE PIPELINE #</span>
<span class="n">pipeline_name</span> <span class="o">=</span> <span class="s2">"Average NDSI Pipeline!"</span>
<span class="n">pipeline_func</span> <span class="o">=</span> <span class="n">daily_ndsi_pipeline</span>
<span class="n">pipeline_filename</span> <span class="o">=</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">'.yaml'</span>
<span class="n">kfp</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">Compiler</span><span class="p">()</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pipeline_func</span><span class="p">,</span> <span class="n">pipeline_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The arguments we will pass in below are to be used for the Run. The username and password will be what you entered above in Section 1, and you can modify the days parameter to any reasonable integer. The polygon and gcs_paths should stay the same as they are hardcoded for this tutorial example.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">arguments</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'days'</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s1">'earthdata_user'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
    <span class="s1">'earthdata_pass'</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
    <span class="s1">'polygon'</span><span class="p">:</span> <span class="s1">'/bc-polygon'</span><span class="p">,</span>
    <span class="s1">'gcs_paths'</span><span class="p">:</span> <span class="s1">'gcs://geoanalytics-user-shared-data/tutorial_data/'</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Finally, let’s run and upload the pipeline!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">count</span><span class="o">=</span><span class="mi">1</span> <span class="c1"># only run once</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># If the experiment under the given name already exists - get it's ID, else - create a new experiment</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">experiment_id</span> <span class="o">=</span> <span class="n">kubeflow_client</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_experiment</span><span class="p">(</span><span class="s2">"daily-avg-ndsi"</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">kubeflow_client</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create_experiment</span><span class="p">(</span><span class="s2">"daily-avg-ndsi"</span><span class="p">)</span>
<span class="n">run_name</span> <span class="o">=</span> <span class="n">pipeline_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">'-run#</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">'</span>
<span class="n">run_result</span> <span class="o">=</span> <span class="n">kubeflow_client</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">run_pipeline</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">run_name</span><span class="p">,</span> <span class="n">pipeline_filename</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2021-09-08 19:36:44 INFO (root): Creating experiment daily-avg-ndsi.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<a href="http://kubeflow.geoanalytics.ca/pipeline/#/experiments/details/23d4aee2-ce95-4869-8a7e-5e309180afc4" target="_blank">Experiment details</a>.</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<a href="http://kubeflow.geoanalytics.ca/pipeline/#/runs/details/21f8d435-b8ae-46ae-a4a3-eda8af64251d" target="_blank">Run details</a>.</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">echo_pipeline</span> <span class="o">=</span> <span class="n">kubeflow_client</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">upload_pipeline</span><span class="p">(</span><span class="n">pipeline_filename</span><span class="p">,</span> <span class="n">pipeline_name</span><span class="p">,</span> <span class="s2">"DAILY AVERAGE NDSI PIPELINE"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<a href="http://kubeflow.geoanalytics.ca/pipeline/#/pipelines/details/0d40765c-4a91-4ba0-af2e-1fde412d00c0">Pipeline details</a>.</div>
</div>
</section>
<section id="4.-The-Results">
<h2>4. The Results<a class="headerlink" href="#4.-The-Results" title="Permalink to this headline">#</a></h2>
<p>Head over to the Kubeflow Pipeline UI and take a look at the Run you created. Once finished, the pipeline graph should look like this image below.</p>
<p><img alt="6587629e29fa43b49b138b526634b07d" src="../_images/01_pipeline-graph.png"/></p>
<p>To see the final plot of the Averaged NDSI over the past few days, click on the <code class="docutils literal notranslate"><span class="pre">plot_ndsi</span></code> operation and under the <strong>“Input/Output”</strong>, click on the link in the Output Artifacts section. This is open a new tab with the final plot shown, which should look similar to this:</p>
<p><img alt="1098285216c74d29860cc32ad7ea04e9" src="../_images/01_pipeline-result.png"/></p>
<p><strong>Note: This NDSI was processed on September 2nd, 2021.</strong></p>
</section>
<section id="5.-Additional-Sources">
<h2>5. Additional Sources<a class="headerlink" href="#5.-Additional-Sources" title="Permalink to this headline">#</a></h2>
<p>For additional information take a look at these resources:</p>
<ul class="simple">
<li><p>Information about the MOD10A Product: <a class="reference external" href="https://nsidc.org/data/MOD10A1/versions/6">https://nsidc.org/data/MOD10A1/versions/6</a></p></li>
<li><p>Building Python Function-based Components: <a class="reference external" href="https://www.kubeflow.org/docs/components/pipelines/sdk/v2/python-function-components/">https://www.kubeflow.org/docs/components/pipelines/sdk/v2/python-function-components/</a></p></li>
<li><p>The GCSFS Documentation: <a class="reference external" href="https://fs-gcsfs.readthedocs.io/en/latest/">https://fs-gcsfs.readthedocs.io/en/latest/</a></p></li>
<li><p>Information about Kubeflow Pipelines Output Artifacts: <a class="reference external" href="https://www.kubeflow.org/docs/components/pipelines/sdk/output-viewer/">https://www.kubeflow.org/docs/components/pipelines/sdk/output-viewer/</a></p></li>
<li><p>The Kubeflow Pipeline SDK API Documentation: <a class="reference external" href="https://kubeflow-pipelines.readthedocs.io/en/latest/index.html">https://kubeflow-pipelines.readthedocs.io/en/latest/index.html</a></p></li>
</ul>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="02-kmeans-dask.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">K-Means Land Classification with Dask</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Scientific Workflows</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Hatfield Consultants
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#"><strong>Daily NDSI Average Pipeline</strong></a><ul>
<li><a class="reference internal" href="#1.-Connect-to-Kubeflow-Client">1. Connect to Kubeflow Client</a></li>
<li><a class="reference internal" href="#2.-Implementing-the-Python-Functions">2. Implementing the Python Functions</a><ul>
<li><a class="reference internal" href="#2.1-Querying-Data-Function">2.1 Querying Data Function</a></li>
<li><a class="reference internal" href="#2.2-Thresholding-and-Creating-Mosaic-Function">2.2 Thresholding and Creating Mosaic Function</a></li>
<li><a class="reference internal" href="#2.3-Computing-Average-NDSI-Function">2.3 Computing Average NDSI Function</a></li>
<li><a class="reference internal" href="#2.4-Plotting-the-Final-NDSI-Function">2.4 Plotting the Final NDSI Function</a></li>
<li><a class="reference internal" href="#2.5-Delete-Files-Function">2.5 Delete Files Function</a></li>
</ul>
</li>
<li><a class="reference internal" href="#3.-Assembling-the-Pipeline">3. Assembling the Pipeline</a></li>
<li><a class="reference internal" href="#4.-The-Results">4. The Results</a></li>
<li><a class="reference internal" href="#5.-Additional-Sources">5. Additional Sources</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/tabs.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>